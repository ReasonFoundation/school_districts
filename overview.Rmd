---
title: "Status of Acfrs data collection 2020 vs. 2021"
output: 
  html_document:
    toc: true
    toc_float: true
date: "2022-01-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height = 9, warning = FALSE, message = FALSE)
library(ggplot2)
library(tidyverse)
library(plotly)
```


# Entity Category

```{r}
db_2020 <- readRDS("data/data_from_dbsite.RDS")

db_2020 %>% 
select(category) %>% 
  group_by(category) %>% 
  add_count() %>% 
  rename("2020" = n) %>% 
  distinct() -> data_by_category_2020

db_2021 <- readRDS("data/data_from_dbsite_2021.RDS") # queried Jan 4

  db_2021 %>% select(category) %>% 
  group_by(category) %>% 
  add_count() %>% 
  rename("2021" = n) %>% 
  distinct() -> data_by_category_2021
  
  
data_count <- data_by_category_2020 %>% left_join(data_by_category_2021)
  
data_count %>% 
  pivot_longer(cols = 2:3,
               names_to = "year",
               values_to = "value") %>% 
  
  ggplot(aes(fct_reorder(category, value), value, group = year, fill = year)) +
  
  geom_col(position = "dodge",  alpha = .5) +
  
  coord_flip() +
  scale_alpha_continuous()+
  
  labs( x = "",
    title = paste0("Count of Entity by Category\n Total # 2020: ",
                  nrow(db_2020), " ~ 2021:", nrow(db_2021)), "\n",
    
    caption = "Data queried on Jan 4, 2023"
  ) +
  
  theme_minimal() -> p
ggplotly(p)
```


```{r}
# test

db_2020 %>% filter(category == "School District" & state == "TX") %>% filter(str_detect(name, "Northside"))
330423641
```


## School District by State

```{r}
# db_2021 %>% filter(category == "School District") %>%
#   group_by(state) %>%
#   add_count() %>%
#   ggplot(aes(fct_reorder(state, n))) +
# 
#   geom_bar(fill = "orange", alpha = .4) +
# 
#   coord_flip() +
# 
# 
#   labs( x = "",
#     title = "Count of School District by State",
#     subtitle = "Total of School District in Acfrs 2021: 9278",
#     caption = "Data queried on Jan 4, 2023"
#   ) +
# 
#   theme_minimal() -> p1
#   ggplotly(p1)
```



```{r}
db_2021 %>% filter(category == "School District") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2021" = n) %>% 
   distinct() -> schooldist_21

db_2020 %>% filter(category == "School District") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2020" = n) %>% 
   distinct() -> schooldist_20

schooldist_20 %>% left_join(schooldist_21) %>% 
  pivot_longer(cols = 2:3, names_to = "year", values_to = "value") %>% 

  ggplot(aes(fct_reorder(state, value), value, fill = year)) +
  geom_col(position = "dodge", alpha = .4) +
  coord_flip() +
  facet_wrap(~year) +
  labs( x = "",
    title = paste0("Count of School District by State 2020: ", sum(schooldist_20$`2020`), " ~ 2021:", sum(schooldist_21$`2021`)), 
   
    caption = "Data queried on Jan 4, 2023"
  ) +
  
  theme_minimal() -> p1


ggplotly(p1)
```

## General Purpose Entity by State


```{r}
db_2021 %>% filter(category == "General Purpose") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2021" = n) %>% 
   distinct() -> general_21

db_2020 %>% filter(category == "General Purpose") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2020" = n) %>% 
   distinct() -> general_20

general_20 %>% left_join(general_21) %>% 
  pivot_longer(cols = 2:3, names_to = "year", values_to = "value") %>% 

  ggplot(aes(fct_reorder(state, value), value, fill = year)) +
  geom_col(position = "dodge", alpha = .4) +
  coord_flip() +
  facet_wrap(~year) +
  labs( x = "",
   
    title = paste0("Count of General Purpose Entity by State 2020: ", sum(general_20$`2020`), " ~ 2021:", sum(general_21$`2021`)),
    caption = "Data queried on Jan 4, 2023"
  ) +
  
  theme_minimal() -> p2
ggplotly(p2)
```

## Special District by State

```{r}
db_2021 %>% filter(category == "Special District") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2021" = n) %>% 
   distinct() -> special_dist_21

db_2020 %>% filter(category == "Special District") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2020" = n) %>% 
   distinct() -> special_dist_20

special_dist_20 %>% left_join(special_dist_21) %>% 
  pivot_longer(cols = 2:3, names_to = "year", values_to = "value") %>% 

  ggplot(aes(fct_reorder(state, value), value, fill = year)) +
  geom_col(position = "dodge", alpha = .4) +
  coord_flip() +
  facet_wrap(~year) +
  labs( x = "",
    title = paste0("Count of Special District by State 2020: ", sum(special_dist_20$`2020`), " ~ 2021:", sum(special_dist_21$`2021`)),
    caption = "Data queried on Jan 4, 2023"
  ) +
  
  theme_minimal() -> p3
ggplotly(p3)
```


## Charter School by State

```{r}
db_2021 %>% filter(category == "Charter School") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2021" = n) %>% 
   distinct() -> charter_21

db_2020 %>% filter(category == "Charter School") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2020" = n) %>% 
   distinct() -> charter_20

charter_20 %>% left_join(charter_21) %>% 
  pivot_longer(cols = 2:3, names_to = "year", values_to = "value") %>% 

  ggplot(aes(fct_reorder(state, value), value, fill = year)) +
  geom_col(position = "dodge", alpha = .4) +
  coord_flip() +
  facet_wrap(~year) +
  labs( x = "",
    title = paste0("Count of Charter School by State 2020: ", sum(charter_20$`2020`), " ~ 2021:", sum(charter_21$`2021`)),
    caption = "Data queried on Jan 4, 2022"
  ) +
  
  theme_minimal() -> p4
ggplotly(p4)
```


## Community College District by State

```{r}
db_2021 %>% 
  filter(category == "Community College District") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2021" = n) %>% 
   distinct() -> com_col_21

db_2020 %>% filter(category == "Community College District") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2020" = n) %>% 
   distinct() -> com_col_20

com_col_20 %>% left_join(com_col_21) %>% 
  pivot_longer(cols = 2:3, names_to = "year", values_to = "value") %>% 

  ggplot(aes(fct_reorder(state, value), value, fill = year)) +
  geom_col(position = "dodge", alpha = .4) +
  coord_flip() +
  facet_wrap(~year) +
  labs( x = "",
  
    title = paste0("Count of Community College District by State 2020: ", sum(com_col_20$`2020`), " ~ 2021:", sum(com_col_21$`2021`)),
    caption = "Data queried on Jan 4, 2022"
  ) +
  
  theme_minimal() -> p5
ggplotly(p5)

```

## Public Higher Education by State

```{r}
db_2021 %>% 
  filter(category == "Public Higher Education") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2021" = n) %>% 
   distinct() -> pub_highed_21

db_2020 %>% filter(category == "Public Higher Education") %>% 
  group_by(state) %>% 
  add_count() %>% select(state, n) %>% 
  rename("2020" = n) %>% 
   distinct() -> pub_highed_20

pub_highed_20 %>% left_join(pub_highed_21) %>% 
  pivot_longer(cols = 2:3, names_to = "year", values_to = "value") %>% 

  ggplot(aes(fct_reorder(state, value), value, fill = year)) +
  geom_col(position = "dodge", alpha = .4) +
  coord_flip() +
  facet_wrap(~year) +
  labs( x = "",
   # title = "Count of Public Higher Education by State",
     title = paste0("Count of Public Higher Education by State 2020: ", sum(pub_highed_20$`2020`), " ~ 2021:", sum(pub_highed_21$`2021`)),
    caption = "Data queried on Jan 4, 2022"
  ) +
  
  theme_minimal() -> p6
ggplotly(p6)

```

# Fields of data

- Category

Type of Government:  General Purpose (e.g.  a state, county, city, town, village or borough), School District, Special District, Community College District or Public Higher Education

- Net Pension Liability

The liability of employers and nonemployer contributing entities to employees for benefits provided through a defined benefit pension plan.

- Net Pension Assets

The excess of net position in a pension system to the total pension liability. It should be measured as the portion of the actuarial present value of projected payments that is attributable to past periods of employee service, net of the pension plan’s fiduciary net position.

- Net OPEB Liability

The net OPEB liability is measured as the portion of the actuarial present value of projected benefit payments that is attributed to past periods of employee service, net of the OPEB plan's fiduciary net position.

- Net OPEB Assets

The net OPEB Asset is computed as the difference between the actuarial present value of projected benefit payments attributed to past periods of employee service and the OPEB plan’s fiduciary net position.

- Total Liabilities

Liabilities are present obligations to sacrifice resources that the government has little or no discretion to avoid. 

- Current Liabilities

Current liabilities are amount of obligations for items that have entered into the operating cycle incurred in the acquisition of materials and supplies to be used in providing services; collections received in advance of the performance of services.

- Current Portion of Long-Term Liabilities

Noncurrent liabilities, due within one year, which are present obligations to sacrifice resources that the government has little or no discretion to avoid.

- Compensated Abseces

Compensated absences payable, classified as noncurrent. Compensated absences are compensated time off such as vacation and sick leave, which has been earned by employees and probable that the employer will compensate the employees through paid time off or some other means, such as cash payments at termination or retirement but not yet compensated by the employer.

- Bonds Outstanding

Amount of debt payments related to the general obligation bonds that are due in current and future reporting periods.

- Loans Outstanding

Aggregate carrying value as of the balance sheet date of loans payable.(Unlike bonds, loans are made directly by another organization such a bank or other unit of government.)

- Notes Outstanding

Amount of all notes owed by the local unit. Debit upon payment of such notes; credit for the face amounts of long-term notes.

(The primary difference between notes payable and bonds stems from securities laws. Bonds are always considered and regulated as securities, while notes payable are not necessarily considered securities. )

- Leases

Represent lease contracts payable in more than one year that convey control of the right to use another entity's nonfinancial asset (the underlying asset) as specified in the contract for a period of time in exchange or exchange-like transaction.

- Revenues

The sum of program revenues and general revenues.

- Expenses

Expenses, which includes an entity's outflows or expiration of assets or the incurrence of liabilities during a period from providing or producing goods, rendering services, or carrying out other activities.

- Charges for Services

Program revenues that arise from charges to customers, applicants, or others who purchase, use, or directly benefit from the goods, services, or privileges provided, or are otherwise directly affected by the services.

- Operating Grants and Contributions

Program revenues from operating grants and contributions. Program revenues are amounts derived directly from the program itself or from parties outside the reporting government's taxpayers or citizenry, as a whole. Program revenues reduce the net cost of the function to be financed from the government's general revenues.

- Capital Grants and Contributions

Program revenues from capital grants and contributions. Program revenues are amounts derived directly from the program itself or from parties outside the reporting government's taxpayers or citizenry, as a whole. Program revenues reduce the net cost of the function to be financed from the government's general revenues.

- General Revenue

The sum of all general revenues, which include taxes, investment income and fines.

- Change in Net Position

Changes in net position which is the difference in net position between the beginning and end of the reporting period.

- Component Unit of

If the entity is a separately reporting component unit, which entity's ACFR shows its financial results as a component

