---
title: "Total Debts & Revenues of All School Districts"
output: html_document
date: "2023-05-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE )
library(dplyr)
library(janitor)
library(DT)
options(scipen = 999)
```
**NOTE**: Excluding District of Columbia, all Delaware school districts, and other 238 school districts that are being collected by Hgarb. 


## Total Liabilities of SD in the current database
```{r}
readRDS("data/data_from_dbsite_2020.RDS") %>% 
  filter(category == "School District") %>% 
  select(total_liabilities, net_pension_liability, net_opeb_liability, revenues, year) %>% 
  mutate(tot_li = sum(total_liabilities),
         tot_pen = sum(net_pension_liability),
         tot_opeb = sum(net_opeb_liability),
         tot_rev = sum(revenues)) %>% slice(1) %>% select(tot_li, tot_pen, tot_opeb, tot_rev, year) -> tot20
```

```{r}
readRDS("data/data_from_dbsite_2021.RDS") %>% 
  filter(category == "School District") %>% 
  select(total_liabilities, net_pension_liability, net_opeb_liability, revenues, year) %>%  
  mutate(tot_li = sum(total_liabilities),
         tot_pen = sum(net_pension_liability),
         tot_opeb = sum(net_opeb_liability),
         tot_rev = sum(revenues)) %>% slice(1) %>% select(tot_li, tot_pen, tot_opeb, tot_rev, year) -> tot21

tot20 %>% rbind(tot21) %>% mutate_each(funs(prettyNum(., big.mark=","))) %>% datatable()

```

### 32 NYC school districts

```{r}
readRDS("nyc_20_21.RDS") %>% select(7:13) %>% distinct() %>% select(-c(doe_expenses, doe_total_asset)) %>% 
  rename(tot_li = doe_total_liabilities,
         tot_pen = doe_net_pension,
         tot_opeb = doe_net_opeb,
         tot_rev = doe_revenues) -> tot_ny32sd

tot_ny32sd %>% mutate_each(funs(prettyNum(., big.mark=","))) %>% datatable()

```
### Other sd that are collected manually in file top100sd.Rmd

"Davidson County", "Portland SD 1J", "Boston", "CHESTERFIELD CO PBLC SCHS", "HENRICO CO PBLC SCHS", "FAIRFAX CO PBLC SCHS", "LOUDOUN CO PBLC SCHS", "PRINCE WILLIAM CO PBLC SCHS", "VA BEACH CITY PBLC SCHS"

```{r}

readRDS("top100_result.RDS") %>% 
  filter(nces_original_name %in% c("Davidson County", "Portland SD 1J", "Boston", "CHESTERFIELD CO PBLC SCHS", "HENRICO CO PBLC SCHS", "FAIRFAX CO PBLC SCHS", "LOUDOUN CO PBLC SCHS", "PRINCE WILLIAM CO PBLC SCHS", "VA BEACH CITY PBLC SCHS")) %>% 
  select(id, total_liabilities, net_pension_liability, net_opeb_liability, revenues, year) %>% 
  group_by(year) %>% 
  mutate(tot_li = sum(total_liabilities),
         tot_pen = sum(net_pension_liability),
         tot_opeb = sum(net_opeb_liability),
         tot_rev = sum(revenues, na.rm = T)) %>% select(tot_li, tot_pen, tot_opeb, tot_rev, year) %>% slice(1:2) %>% distinct()-> tot_othersd

tot_othersd %>% mutate_each(funs(prettyNum(., big.mark=","))) %>% datatable()

```

## Adding all together 

```{r}
tot20 %>% rbind(tot21) %>% 
  # 32 NYC 
  rbind(tot_ny32sd) %>% 
  
  # others
  rbind(tot_othersd) %>% 
  
  group_by(year) %>% 
  mutate(all_sd_liabilities = sum(tot_li),
         all_sd_pension = sum(tot_pen),
         all_sd_opeb = sum(tot_opeb),
         all_sd_rev = sum(tot_rev)
         
         ) %>% select(5:9) %>% 
  distinct() %>% mutate_each(funs(prettyNum(., big.mark=","))) %>% datatable()
```

