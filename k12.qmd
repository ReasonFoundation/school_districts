---
title: "Untitled"
editor: visual
format: html
---

## Running Code

```{r}

library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
library(janitor)
library(plotly)

options(scipen = 999)
```

# Total Liability & Total Asset 2020 \~ 2021

## 2020

```{r}
# SD from database Jan 27 2023, before name matching & Hgarb manually added
sd2020_db <- readRDS("data/data_from_dbsite.RDS") %>% 
  filter(category == "School District")

sd2020_summary_db <- sd2020_db %>% 
  select(total_liabilities, net_pension_liability, net_pension_assets) %>% 
  mutate(tot_liability = sum(total_liabilities),
    tot_netpension_liability = sum(net_pension_liability), 
    tot_netpension_asset = sum(net_pension_assets)) %>% 
    select(tot_liability, tot_netpension_liability, tot_netpension_asset) %>% 
    distinct()

#write.csv(sd2020_db, "sd2020_db.csv")

```

## 2021

```{r}

sd2021_db <- readRDS("data/data_from_dbsite_2021.RDS") %>% # queried Feb 16
  filter(category == "School District")

sd2021_summary_db <- sd2021_db %>% 
  select(total_liabilities, net_pension_liability, net_pension_assets) %>% 
  mutate(tot_liability = sum(total_liabilities),
    tot_netpension_liability = sum(net_pension_liability), 
    tot_netpension_asset = sum(net_pension_assets)) %>% 
    select(tot_liability, tot_netpension_liability, tot_netpension_asset) %>% 
    distinct()  
#write.csv(sd2021_db, "sd2021_db.csv")

```

```{r}
sum_sd_data <- sd2020_summary_namematched_Hgarb %>% 
  rbind(sd2020_summary_db) %>% 
  rbind(sd2021_summary_db) %>% 
  mutate(year = c("2020_additional_collection", "2020_first_collection", "2021_first_collection"), 
         number_sd = c(11536, 9619, 10418))

# Number of School District Collected
sum_sd_data %>% 
  ggplot(aes(year, number_sd)) +
  geom_col(fill = "darkgreen") +
  labs(title = "Number of School District Collected") +
  theme_minimal() -> foo1

```

```{r}
sum_sd_data %>% 
  
  # remove total liability in 2020 additional because HGarb did not collect this fully
  mutate(tot_liability = ifelse(year == "2020_additional_collection", 0, tot_liability)) %>% 
  pivot_longer(cols = c(tot_netpension_asset, tot_netpension_liability, tot_liability),
               names_to = "type", 
               values_to = "value") %>% 
#mutate(value_char = format(d$value, big.mark = ",", scientific = FALSE)) %>% 
  
  ggplot(aes(year, value, group = type, fill = type)) +
  geom_col(position = "dodge") +        
  labs(y = "") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  #scale_y_continuous(breaks = c(0, 1500000000000, 5000000000)) +
  theme_minimal() -> foo2

ggplotly(foo2)
```

## Top 100 SD NCES


NCES data set has 13,713 school districts across 50 states and 5 US territories, accounts for 48,420,226 students. This analysis only concerns 13,707 school districts in 50 states, accounts for a total of 48,026,570 students.

```{r}
# View those lacking NCES ID within the set HGarb added - 817 lacks NCES ID
sd2020_namematched_Hgarb %>% #select(`NCES ID`, `Net Pension Liability`, `Net Pension Asset`) %>%
  filter(is.na(ncesID)) 

# Question: what is the significance about these school districts that do not have NCES ID?
  
  # check top Net Pension Liability
  # filter(!is.na(`Net Pension Liability`)) %>% 
  # arrange(desc(`Net Pension Liability`)) # top is Douglas County School District #0001 in NE

# find that in NCES - 
# nces %>% 
#   filter(state == "NE") %>% 
#   filter(str_detect(name, "douglas")) # ncesID 3100165

```

What's left?

```{r}
# Missing sd
nces %>% filter(ncesID %in% sd_2020_combined$ncesID) %>% arrange(desc(students)) #%>% write.csv("missingSD_all.csv")

db2021 %>% filter(state == "DE")
nces %>% filter(state == "DE") %>% write.csv("list_school_districts_delaware.csv")
```

```{r}
# Breakdown of missing 2998 SD by number of students
nces %>% filter(!ncesID %in% sd_2020_combined$ncesID) %>% arrange(desc(students)) %>%  
mutate(student_num = case_when(students >= 40000 ~ "40,000 or more",
                               students >= 20000 ~ "20,000 ~ 40,000",
                       students >= 10000 ~ "10,000 ~ 20,000", # American Samoa is one of these
                       students >= 5000 ~ "5,000 ~ 10,000",
                       students < 5000 ~ "less than 5,000"
                       )) %>% 
       add_count(student_num) %>% distinct(student_num, n) 
#%>% write.csv("missingSD_breakdown_bystudents.csv") 
```

```{r}
# Breakdown of number of missing SD by state
nces %>% filter(!ncesID %in% sd_2020_combined$ncesID) %>% 
  add_count(state) %>% 
  select(state, n) %>% arrange(desc(n)) %>% distinct() %>% filter(state == "DE")

nces %>% filter(state == "DE")
#%>% write.csv("missingSD_breadown_byState.csv")
```

```{r}
# Breakdown of rate of missing students by state
nces %>% group_by(state) %>% mutate(tot_student_state = sum(students)) %>% 
  
  filter(!ncesID %in% sd_2020_combined$ncesID) %>% 
  mutate(missing_student_state = sum(students)) %>% 
  select(state, tot_student_state, missing_student_state) %>% distinct() %>% 
  mutate(missing_rate = round(missing_student_state/tot_student_state,2)) %>% 
  arrange(desc(missing_rate)) 
#%>% write.csv("missing_numberStudent_breadown_byState.csv")
```

Top sd in NCES & Acfrs


"Actual Department of Education revenues are listed on p. 239 and were 13,491,950,437 in 2020 and 13,417,503,839 in 2019. Department expenses are on p. 279 and were \$27,903,294,638 in 2020."

Secondly, we will apportion liabilities based on employee count. Liabilities should come from the chart on p. 42.

Revenue Dept of Education 2020: 13491950437 Expenses Dept of Education 2020: 27903294638 Net pension liability: 46376874000 Net OPEB liability: 109456918000 Total liabilities: Governmental activities 304831464000; total 305300557000

Employee head counts are listed on p. 402. Our ratio should be: ((Pedagogical + Non-Pedagogical)/Total) \* Apportionment to each district based on student enrollment.

Employee head counts: Pedagogical: 121077 Non-pedagogical: 13607 Total: 300446

(121077+13607)/300446

```{r}
# 5 SD 
top108_sd_nces %>% filter(state == "NY")
#staff: 
(121077+13607)/300446 = 0.448

# liabilities of school districts in NY city

#Net pension liability: 
  46376874000 * 0.448
#Net OPEB liability: 
  109456918000 * 0.448
#Total liabilities: Governmental activities 304831464000; total 
  305300557000 * 0.448

  # School district in New York City: 
sd_NYcity <- nces %>% filter(city == "NEW YORK") %>% 
  mutate(student_share = students/sum(students),
         employee_share = (121077+13607)/300446, # ((Pedagogical + Non-Pedagogical)/Total)
         total_liabilities = 305300557000*employee_share*student_share, # The city of NY Total liabilities: Governmental activities 304831464000; total 305300557000
         net_pension_liability = 46376874000*employee_share*student_share, # The city of NY Net pension liability: 46376874000
         net_opeb_liability = 109456918000*employee_share*student_share, # The city of NY Net OPEB liability: 109456918000
         revenues = 13491950437*student_share, # Revenue Dept of Education 2020: 13491950437
         expenses = 27903294638*student_share ) # Expenses Dept of Education 2020: 27903294638


# Note: this only account for NEW YORK CITY GEOGRAPHIC DISTRICT in New York City, there are other located in other cities in NY state. 
nces %>% filter(str_detect(nces_original_name, "NEW YORK CITY GEOGRAPHIC DISTRICT"))

#==> Question: Only 7 of the total 32 NEW YORK CITY GEOGRAPHIC DISTRICT belongs to NY city? Or all of them?
```

```{r}
# 8 sd in top 108 sd in NCES but not collected in Acfrs are:
top108_sd_nces %>% 
  filter(!ncesID %in% top100_sd2020_acfrs$ncesID) 

# search in portal https://acfrs.reason.org/: could not find NY New York City Geographic District
 # not found Davidson county TN
# Found Northside TX - check again in  sd2020_collected
  

   sd_2020_combined %>% 
     filter(str_detect(name, "Northside")) # this NCES ID 4833090 has only 236 student, ACfrs shows its net pension liability is 330423641 . https://nces.ed.gov/ccd/districtsearch/district_detail.asp?Search=2&details=1&ID2=4833090&DistrictID=4833090
   
   
# This ID "Northside" ID 4833120 is in San Antonio, which has 107817 students - found the pdf file on portal. Why not found in acfrs data? ==> Need to update queries data from database?
 nces %>% 
     filter(state == "TX") %>% 
     filter(ncesID == "4833120")   
   # check in acfrs collected
   sd_2020_combined %>% filter(state == "TX") %>% filter(str_detect(name, "Northside"))
   
sd2020_db %>% 
  filter(str_detect(name, "Northside"))
```

# Geoff:

Conroe Independent School District 2021: Done

Northside TX 2021 in sd2021_db, adding this total Assets: 3222278252

## Analyze top 100 school districts 2020

```{r}
top100_sd2020 <- top100_sd2020_acfrs %>% left_join(top108_sd_nces) %>% 
  clean_names() %>% 
  select(nces_id, id, state, name, year, total_liabilities, net_pension_liability, revenues, students) %>% 
  arrange(desc(students)) 
  #filter(is.na(net_pension_liability)) #  6 of them do not have net pension liability?
  
# This list of 100 sd falls within the list of 106 largest sd here https://nces.ed.gov/programs/digest/d20/tables/dt20_215.30.asp
# lacking: New York City
#Northside TX
# conroe ISD TX
# Porland OR
# capistrano United
```

```{r}
# get ncesID into sd 2021

top100_sd2021 <- sd2021_db %>% left_join(sd_name_ncesId) %>% 
  
# filter out top 100 sd in acfrs 2021 that has id in top100 sd 2020
filter(id %in% top100_sd2020_acfrs$id) %>% 
  select(ncesID, state, name, year, total_liabilities, net_pension_liability, revenues)
```

Top 100 SD 2020 2021

```{r}
# 14 sd in 2020 but not found in 2021
setdiff(top100_sd2020$name, top100_sd2021$name)


sd2020 <- top100_sd2020 %>% #select(-year) 
#%>% 
  rename(ncesID = nces_id) %>% 
  pivot_longer(cols = 5:7,
               names_to = "category",
               values_to = "value2020") %>% arrange()


sd2021 <- top100_sd2021 %>% select(-year) #%>% 
    pivot_longer(cols = 4:6,
                 names_to = "category",
                 values_to = "value2021") %>% select(-c(name, state, category))

sd2020 %>% left_join(sd2021, by = c("ncesID")) -> d



```

```{r}
library(forcats)
top100_sd2020 %>% 
  mutate(liab_rev_ratio = total_liabilities/revenues) %>% arrange(liab_rev_ratio) %>% 
  ggplot(aes(fct_reorder(name, liab_rev_ratio), liab_rev_ratio))+
    geom_col(fill = "cornflowerblue")+
  coord_flip() -> a
 # ggplotly(a)
    
```

```{r}
top100_sd2020 %>% arrange(desc(revenues)) %>% 
  ggplot(aes(revenues, total_liabilities))+
  geom_point(color = "darkgreen") +
  labs(title = "Revenues vs Total Liability in top 100 school districts 2020") +
  theme_minimal() -> b
ggplotly(b)

```

```{r}
top100_sd2020 %>% filter(!name %in% c("Los Angeles Unified School District", "Chicago Board of Education")) %>% 
  ggplot(aes(revenues, total_liabilities))+
  geom_point(color = "darkgreen") +
labs(title = "Revenues vs Total Liability in top 100 school districts 2020\n Excluding 2 outliers") +
  theme_minimal()-> c
ggplotly(c)
```

```{r}
top100_sd2020 %>% 
  mutate(liability_student = total_liabilities/students,
         revenues_student = revenues/students) %>% 
  select(name, liability_student, revenues_student) %>% arrange(desc(liability_student)) %>% slice(1:10) %>% 
  pivot_longer(cols = 2:3,
               names_to = "type",
               values_to = "value") %>% 
  ggplot(aes(fct_reorder(name, value), value, group = type, fill = type)) +
  geom_col(position = "dodge") + 
  coord_flip() +
  labs(title = "Liability and Revenue per student, year 2020") +
  theme_minimal()

```

```{r}



# entities in 2020 but not in 2021
left_join(sd2020_db, sd2021_db, by = "id") %>% #select(id, name.x, name.y)
  filter(is.na(name.y)) # %>% write.csv("school_districts_in2020_NOTin2021.csv")

#test: Cleveland Heights-University Heights City School District
sd2021_db %>% filter(str_detect(name, "Cleveland")) 
#Peru Community Schools IN
sd2021_db %>% filter(str_detect(name, "Peru")) 

# entities in 2021 but not in 2020
left_join(sd2021_db, sd2020_db, by = "id") %>% 
  filter(is.na(name.y)) #%>% write.csv("school_district_in2021_NOTin2020.csv")
# test: Cedar Ridge School District AR

sd2020_db %>% filter(id == 42819)
sd2021_db %>% filter(id == 42819)




```

# TX 49564 TX Meridian Independent School Distric 2021: not yet processed

# PA 386816 PA Annville-Cleona School District 2021: not yet processed

# MS 42819 Houston School District 2021: not found

# GA 32615 Peach County Board of Education 2021: not found

# CA 146639 Seiad Elementary School District, 2021: not found

```{r}
# in both
left_join(sd2020_db, sd2021_db, by = "id") %>% #select(id, name.x, name.y)
  filter(!is.na(name.y))  
  
  # find top 100 sd in 2021 from Acfrs
sd2021_db %>% 
  mutate(name == str_trim(name)) %>% 
  filter(name %in% top100_sd_acfrs$acfrs_original_name) -> top56_sd_2021


top100_sd_acfrs %>% 
  #filter(str_detect(acfrs_original_name,"Miami-Dade County")) #The School Board of Miami-Dade County
# must be equivalent to: 
filter(acfrs_original_name == "The School Board Of Miami-Dade County")

# only found 56, how the about other 44?
top100_sd_acfrs %>% 
  filter(!acfrs_original_name %in% top56_sd_2021$name) -> lacking45

# list of those in 100 largest sd not collected yet in 2021
sd2021_db %>% 
  filter(str_detect(name, "Broward")) #"District of Columbia"))
```

```{r}
# Enrollment, poverty, and federal funds for the 120 largest school districts, by enrollment size in 2017: 2016-17 and fiscal year 2019
# https://nces.ed.gov/programs/digest/d20/tables/dt20_215.30.asp

read.csv("data/tabn215.30.csv") %>% select(1:2,4) %>% 
  slice(4:123) %>% 
  rename(district_name = 1, 
         state = 2, 
         students = 3) %>% 
  mutate(students = as.numeric(str_replace_all(students, ",", "")))
         
```



```{r}
library(plotly)
library(forcats)
top100_sd_acfrs %>% 
  rename(name = `School District (Portal Name)`,
         net_pension_liability_2020 = `Net Pension Liability`) %>% 
  select(ncesID, State, name, net_pension_liability_2020) %>% 
  clean_names() -> top100_2020


top56_sd_2021 %>% select(state, name, id, net_pension_liability) %>% 
  rename(net_pension_liability_2021 = net_pension_liability)-> top56_2021


top100_2020 %>% left_join(top56_2021) %>% drop_na(net_pension_liability_2021) %>% 
  select(state, name, net_pension_liability_2020, net_pension_liability_2021) %>% 
  arrange(net_pension_liability_2020) %>% 
  pivot_longer(cols = 3:4,
               names_to = "year",
               values_to = "value") -> d_viz
 
# d_viz %>%
# ggplot(aes(fct_reorder(name, value), value, fill = year)) +
#   geom_col(position = "dodge", alpha = .4) +
#   coord_flip() +
#   facet_wrap(~year) 


top100_2020 %>% left_join(top56_2021) %>% drop_na(net_pension_liability_2021) %>% 
  select(state, name, net_pension_liability_2020, net_pension_liability_2021) -> d_sum

d_sum %>% filter(is.na(net_pension_liability_2020))


sum(d_sum$net_pension_liability_2020, na.rm = TRUE)

sum(d_sum$net_pension_liability_2021, na.rm = TRUE)


```
