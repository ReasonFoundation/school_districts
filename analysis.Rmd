---
title: "Analysis"
output: html_document
date: "2024-01-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
library(janitor)
library(plotly)
library(forcats)
library(DT)
options(scipen = 999)
```

```{r}
db2020 <- readRDS("data/data_from_dbsite_2020.RDS") 
db2021 <- readRDS("data/data_from_dbsite_2021.RDS") 
db2022 <- readRDS("data/data_from_dbsite_2022.RDS") 

full_acfrs_20_21_22 <- rbind(db2020, db2021, db2022) %>% 
  filter(category %in% c("General Purpose", "School District")) %>% 
  select(-c(6:11, 35, 36))

full_acfrs_20_21_22 %>% write.csv("full_acfrs_20_21_22.csv")
```
## Top 100 largest school districts count by state

```{r echo=FALSE }
library(forcats)
top100_result %>% 
  filter(year == 2020) %>% 
  #group_by(year) %>% # to add count of each year
  add_count(state) %>% select(state, n, year) %>% distinct() %>% arrange(desc(n)) %>% 
  ggplot(aes(fct_reorder(state, n), n, group = year, label = n)) +
  geom_col(fill = "purple", alpha = .4) +
  geom_text(color = "purple", nudge_y = 0.3) +
  #facet_wrap(~year) +
  coord_flip() +
  labs(title = "Top 102 largest school districts count by state",
       x = "",
       y = "Number of school district") +
  theme_minimal() 
```

# Per Student 
## Total Liabilities per Student

```{r echo=FALSE}
top100_result %>% 
  ggplot(aes(students, total_liabilities, label = nces_original_name, group = year))+
  geom_point(aes(size = liability_per_student, color = year)) +
  geom_text(data = top100_result %>% arrange(desc(liability_per_student)) %>% slice(1:4)) +
  
  scale_y_continuous(labels = scales::dollar_format())+

labs(x = "Students (Size of circles represents size of liability per student)", y = "Total Liabilities",
     title = "Total Liabilities per Student FY 2020 & 2021",  
     caption = "Size of circles represents size liability per student") +
 theme_minimal()+
  theme(legend.position = "none",
        plot.margin = margin(t = 20,  # Top margin
                             r = 50,  # Right margin
                             b = 40,  # Bottom margin
                             l = 10)) -> p  # Left margin)
        
ggplotly(p)
  
```

## Net Pension Liabilities per Student

```{r echo=FALSE }
top100_result %>% 
  ggplot(aes(students, net_pension_liability, label = nces_original_name, group = year))+
  geom_point(aes(size = netpension_per_student, color = year)) +
  geom_text(data = top100_result %>% arrange(desc(netpension_per_student)) %>% slice(1:3), nudge_y = 1000000000, color = "darkgreen") +
  
  scale_y_continuous(labels = scales::dollar_format())+
 
labs(x = "Students", y = "Net Pension Liabilities",
     title = "Net Pension Liabilities per Student") +
 theme_minimal()+
  theme(
        legend.position = "none",
        plot.margin = margin(t = 20,  # Top margin
                             r = 50,  # Right margin
                             b = 40,  # Bottom margin
                             l = 10)) -> p2 # Left margin)
        
ggplotly(p2)
```

## Net OPEB Liabilities per Student

```{r echo = FALSE}
top100_result %>% 
  ggplot(aes(students, net_opeb_liability, label = nces_original_name, group = year))+
  geom_point(aes(size = netOPEB_per_student, color = year)) +
  geom_text(data = top100_result %>% arrange(desc(netOPEB_per_student)) %>% slice(1:3), color = "orange") +
  
  scale_y_continuous(labels = scales::dollar_format())+
  #scale_x_discrete(labels = scales::comma_format())+
 
labs(x = "Students", y = "Net OPEB Liabilities",
     title = "Net OPEB Liabilities per Student") +
 theme_minimal()+
  theme(
        legend.position = "none",
        plot.margin = margin(t = 20,  # Top margin
                             r = 50,  # Right margin
                             b = 40,  # Bottom margin
                             l = 10)) -> p3 # Left margin)
        

ggplotly(p3)
```

# Total Liabilities-to-Revenues Ratio

## Plot 
```{r echo = FALSE}
top100_result %>% 
  ggplot(aes(total_liabilities, revenues, label = nces_original_name, group = year))+
  geom_point(aes(size = liability_rev_ratio, color = year)) +
  #geom_text(data = top100_result %>% arrange(desc(liability_rev_ratio)) %>% slice(1:3), color = "red") +
  
  scale_y_continuous(labels = scales::dollar_format())+
   scale_x_continuous(labels = scales::dollar_format())+
  geom_abline(intercept = 0, slope = 1, 
       col = "blue",
       lwd = 1) +

labs(x = "Total liabilities", y = "Revenues", 
     title = "Total liabilities to Revenue ratio") +
 theme_minimal()+
  theme(
        legend.position = "none",
        plot.margin = margin(t = 20,  # Top margin
                             r = 50,  # Right margin
                             b = 40,  # Bottom margin
                             l = 10)) -> p4 # Left margin)
        
ggplotly(p4)
```

The majority of SD has total liability to revenues ratio larger than 1 (points below the diagonal line). 

## Table
```{r}
top100_result %>% 
  select(1:2,5, liability_rev_ratio) %>% 
  arrange(liability_rev_ratio) -> ratio

datatable(ratio)
```

# Top 10 largest SD by enrollment 

## Percentage changes 2020-2021 in each category: Table

* Increases in most categories. 

* Palm Beach FL has a steep decrease in net OPEB liability (66% decrease) & a large increase in net pension liability (30% increase)
```{r echo=FALSE}
library(hrbrthemes)
library(viridis)
top100_result %>% arrange(desc(students)) %>% filter(state != "PR") %>% slice(1:20) -> top10_enrollment

top10_enrollment %>% 
  pivot_longer(cols = 9:13,
               names_to = "cat",
               values_to = "value") %>% 
  select(ncesID, nces_original_name, year, cat, value, state) %>% 
  mutate(cat = paste0(cat, "_", year)) %>% select(-year) %>% 
  pivot_wider(names_from = cat, values_from = value) %>% 
 
  # change in % 2021 - 2020
  mutate(total_liabilities_change = round((total_liabilities_2021/total_liabilities_2020 - 1)*100,2),
         revenues_change = round((revenues_2021/revenues_2020 - 1)*100,2),
         net_opeb_change = round((net_opeb_liability_2021/net_opeb_liability_2020 -1) *100,2),
         net_pension_change = round((net_pension_liability_2021/net_pension_liability_2020 -1)*100,2),
         expenses_change = round((expenses_2021/expenses_2020 -1)*100,2)
         ) %>% 
  select(nces_original_name, state, contains("_change")) -> d_change_2020_2021
  
datatable(d_change_2020_2021)
```
##  Percentage changes 2020-2021 in each category: Plot

```{r fig.width=10, fig.height=8, echo = FALSE}
  d_change_2020_2021 %>% 
  pivot_longer(cols = 3:7,
               names_to = "cat", 
               values_to = "value") %>% 
  ggplot(aes(x = nces_original_name, y = value, fill = cat)) +
  geom_bar(position=position_dodge(width = 0.5), stat="identity") +
  coord_flip() +
  scale_fill_viridis(discrete=TRUE, name="") +
  theme_minimal() +
  labs(title = "Percentage changes between FY 2020- 2021 in each category\nTop 10 School Districts by Enrollment", 
    y = "Percentage change",
       x = "")

```

## Total Assets-to-Total Liabilities Ratio 

```{r echo=FALSE}
top10_enrollment %>% 
  mutate(total_assets = c(6833017932, 7209306551,# orange 
                          21980711000,23595338000, #Los Angeles Unified
                          9604959000, 9811425000, # p46, p44 City of Chicago SD 299 (Chicago Board of Education)
                          3191956305, 3446573794, #p 21 Fairfax County Public Schools
                          2877535862, 3053351000, #year 2021 p15 
                          7030148493, 7260377355, #CLARK COUNTY
                          6592207393, 6718508279, #p18, HOUSTON
                          4122013000, 4420987000, #Broward, viewing in current acfrs database has id 425808?
                          5663054000, 5860029000, #MIAMI-DADE
                          4514995000, 4754496000)) %>%  #PALM BEACH
  select(nces_original_name, state, year, total_liabilities, total_assets) %>% 
  mutate(asset_liab_ratio = round(total_assets/total_liabilities, 2)) -> d_asset_liab_ratio


d_asset_liab_ratio %>% 
  ggplot(aes(fct_reorder(nces_original_name, asset_liab_ratio), asset_liab_ratio, group = year )) +
  geom_col(aes(fill = year), position = "dodge") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Total Assets-to-Total Liability Ratio, FY 2020-2021\nTop 10 School Districts by Enrollment", 
       x = "", 
       y = "Ratio") +
  theme(legend.position = "none") -> p_asset_liab_ratio

ggplotly(p_asset_liab_ratio)
```

## Total Liabilities-to-Revenues Ratio
```{r echo = FALSE}
top100_result %>% 
  filter(year == 2020) %>% 
  arrange(desc(liability_rev_ratio)) %>% slice(1:10) -> top10_ratio_2020

top100_result %>% 
  filter(year == 2021) %>% 
  arrange(desc(liability_rev_ratio)) %>% slice(1:10) -> top10_ratio_2021

top10_ratio_2020 %>% 
  ggplot(aes(fct_reorder(nces_original_name, liability_rev_ratio), liability_rev_ratio, group = year)) +
    geom_bar(aes(fill = year), stat="identity", position = position_dodge(width = 0.5)) +
  coord_flip() +
  labs(title = "Top 10 Total Liabilities-to-Revenues Ratio\nFY 2020",
       x = "",
       y = "Total Liabilities-to-Revenues Ratio") +
  theme_minimal() +
  
  theme(legend.position = "none",
        plot.margin = margin(t = 20,  # Top margin
                             r = 50,  # Right margin
                             b = 40,  # Bottom margin
                             l = 10)) -> p_topratio20

p_topratio20

top10_ratio_2021 %>% 
  ggplot(aes(fct_reorder(nces_original_name, liability_rev_ratio), liability_rev_ratio, group = year)) +
    geom_bar(aes(fill = year), stat="identity", position = position_dodge(width = 0.5)) +
  coord_flip() +
  labs(title = "Top 10 Total Liabilities-to-Revenues Ratio\nFY 2021",
       x = "", 
       y = "Total Liabilities-to-Revenues Ratio") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 20,  # Top margin
                             r = 50,  # Right margin
                             b = 40,  # Bottom margin
                             l = 10)) -> p_topratio21

p_topratio21

```


# List of instances where an entity's liability accounts went from a positive number to zero year-over-year

```{r}
full_acfrs_20_21_22 %>% 
  filter(year == 2020 & net_pension_liability > 0) %>% 
   filter(year == 2021 & net_pension_liability == 0)
  

full_acfrs_20_21_22 %>% 
  filter(year == 2021 & net_pension_liability > 0) %>% 
   filter(year == 2022 & net_pension_liability == 0)

full_acfrs_20_21_22 %>% 
  filter(year == 2022 & net_pension_liability > 0) 

  #####
full_acfrs_20_21_22 %>% 
  filter(year == 2020 & total_liabilities > 0) %>% 
   filter(year == 2021 & total_liabilities == 0)
  

full_acfrs_20_21_22 %>% 
  filter(year == 2021 & total_liabilities > 0) %>% 
   filter(year == 2022 & total_liabilities == 0)
```



